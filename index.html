<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>MJ Partlha</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css" />
        <link rel="stylesheet" href="assets/plugins/font-awesome-4.7.0/css/font-awesome.min.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="assets/css/prism.css">
        <link rel="stylesheet" type="text/css" href="assets/css/main.css" />

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <script src="http://malsup.github.com/jquery.cycle2.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js" integrity="sha256-VNbX9NjQNRW+Bk02G/RO6WiTKuhncWI4Ey7LkSbE+5s=" crossorigin="anonymous"></script>
    </head>
    <body>
        <section class="tutorial">
            <div class="blue-header">
                <div class="container">
                    <h1>IMPROVING OPEN JUSTICE VISUALIZATIONS: <span>A TUTORIAL</span></h1>
                    <h3 class="subtitle">by MINJUST</h3>
                </div>
            </div>
            <div class="container">
                <div class="col-sm-9 col-xs-12">

                    <h2>Introdução</h2>
                    <p>Este site pretende ser um guia de como melhor usar dados disponíveis na plataforma de justiça aberta.</p>
                    <p>Irão ser mostrados alguns exemplos de como criar visualizações de dados (gráficos) através de alguma tecnologias open-source em formato aberto (XML, CSV e JSON).</p>

                    <h2 class="blue-text">Visualizações Simples</h2>

                    <h3 id="charts">Charts</h3>

                    <p>● Inserir a API do CKAN (JSON)</p>
                    <pre><code class="language-php">$url= 'http://ckandev.northeurope.cloudapp.azure.com';
$urlPath = '/api/action/datastore_search';
$graph = file_get_contents($url.$urlPath.'?resource_id=e692486c-e84c-48db-a119-e7bfea4f45e1');</code></pre>

                    <p>● Incluir a library <a href="http://www.chartjs.org" target="_blank">ChartJS</a> (<a
                            href="http://www.chartjs.org/docs/latest" target="_blank">documentação</a>)</p>
                    <pre><code class="language-html">&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js">&lt;/script></code></pre>

                    <p>● Criar um canvas para desenhar o gráfico</p>
                    <pre><code class="language-html">&lt;canvas id="graph" class="embedGraph" style="height:200px;">&lt;/canvas></code></pre>

                    <p>● Preparar os dados vindos da API</p>
                    <pre><code class="language-js">var graphData = &lt;?php echo $graph; ?>;
graphData = graphData.result.records;

function getLabels(data){
    var temp = [];
    data.forEach(function(result){
        temp.push(result.Year.toString());
    });
    return temp;
}
function getDatasetdata(data, property) {
    var temp = [];
    data.forEach(function(result){
        temp.push(result[property]);
    });
    return temp;
}

var graphData = {
    labels: getLabels(graphData),
    datasets: [{
        label: 'Número de Jovens',
        backgroundColor: "rgba(13, 206, 169, 0.3)",
        borderColor: "rgba(13, 206, 169, 1)",
        borderWidth: 1,
        data: getDatasetdata(graphData, 'NumeroJovens')
    }]
};</code></pre>

                    <p>● Renderizar os dados</p>
                    <pre><code class="language-js">new Chart(document.getElementById("graph").getContext('2d'), {
    type: 'line',
    data: graphData,
    options: {
        responsive: true,
        tooltips: {
            mode: 'index',
            intersect: false,
        },
        hover: {
            mode: 'nearest',
            intersect: true
        }
    }
});</code></pre>

                    <h3 id="googlemaps">Google Maps</h3>

                    <p>● Incluir as libraries <a href="https://code.jquery.com" target="_blank">JQuery</a>, <a href="https://developers.google.com/maps" target="_blank">Google API</a> e
                        <a href="https://developers.google.com/maps/documentation/javascript/marker-clustering" target="_blank">Marker Clustering</a></p>
                    <pre><code class="language-html">&lt;script src="https://code.jquery.com/jquery-3.2.1.min.js">&lt;/script>
&lt;script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYBIA3hyZj7IWEF77_UPlSGWSwgJWs6pE&callback=init" async defer>&lt;/script>
&lt;script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">&lt;/script></code></pre>

                    <p>● Criar o elemento que irá conter o gráfico</p>
                    <pre><code class="language-html">&lt;style type="text/css" media="screen">
    #map{
        width: 100vw;
        height: 100vh;
    }
    .labels{
        color: white;
    }
&lt;/style>
&lt;div id="map">&lt;/div></code></pre>

                    <p>● Definir a cor dos clusters</p>
                    <pre><code class="language-js">const colors=['#FF530D','#E82C0C','#FF0000'];</code></pre>

                    <p>● Gerar um SVG customizado para o markercluster</p>
                    <pre><code class="language-js">function getGoogleClusterInlineSvg(color){
    let encoded = window.btoa('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-100 -100 200 200"><defs><g id="a" transform="rotate(45)"><path d="M0 47A47 47 0 0 0 47 0L62 0A62 62 0 0 1 0 62Z" fill-opacity="0.7"/><path d="M0 67A67 67 0 0 0 67 0L81 0A81 81 0 0 1 0 81Z" fill-opacity="0.5"/><path d="M0 86A86 86 0 0 0 86 0L100 0A100 100 0 0 1 0 100Z" fill-opacity="0.3"/></g></defs><g fill="' + color + '"><circle r="42"/><use xlink:href="#a"/><g transform="rotate(120)"><use xlink:href="#a"/></g><g transform="rotate(240)"><use xlink:href="#a"/></g></g></svg>')
    return ('data:image/svg+xml;base64,' + encoded)
};</code></pre>

                    <p>● Criar os diferentes estilos de clusters</p>
                    <pre><code class="language-js">let cluster_styles = [
    {
        width: 40,
        height: 40,
        url: getGoogleClusterInlineSvg(colors[0]),
        textColor: 'white',
        textSize: 12
    },
    {
        width: 50,
            height: 50,
        url: getGoogleClusterInlineSvg(colors[1]),
        textColor: 'white',
        textSize: 14
    },
    {
        width: 60,
            height: 60,
        url: getGoogleClusterInlineSvg(colors[2]),
        textColor: 'white',
        textSize: 16
    }
]</code></pre>

                    <p>● Adicionar a CKAN API, o parent HTML e as map options ao método getData</p>
                    <pre><code class="language-js">function init(){
    getData('http://ckandev.northeurope.cloudapp.azure.com/api/action/datastore_search_sql?sql=SELECT%20*%20from%20%2233b2ce95-7079-45e3-a35b-e504ef8f24ae%22%20WHERE%20%22Year%22=2017','http://ckandev.northeurope.cloudapp.azure.com/api/action/datastore_search_sql?sql=SELECT * from "bbac8a5d-0201-45bc-91d1-73e1b87f7e2f"',
        document.getElementById('map'),
    {
        center:{lat:38.73,lng:-9.14},
        zoom:5
    })
}</code></pre>

                    <p>● Funções auxiliares</p>
                    <pre><code class="language-js">//creates a map object
function createMap(mapOptions,element){
    return new google.maps.Map(element, mapOptions)
}

//transforms the data and creates clusters
function transformData(data,locations,map){
    data.map(d => {
        let loc;
    locations.forEach(location => {
        if(location.Concelho === d.Location){
        loc = location
        return
    }
})
    Object.assign(d,{
        pos:{
            lat:parseFloat(loc.Latitude),
            lng:parseFloat(loc.Longitude)
        }
    })
    return d

})
    let markers = data.map(d =>
        addMarker({
            data:d.Total,
            pos:d.pos
        },map))

    let markerCluster=new MarkerClusterer(map,markers,{
        styles:cluster_styles
    })

}

//getData gets the data  and creates the map
function getData(url, url2, element, mapOptions){
    let map = createMap(mapOptions, element)
    request(url)
        .then(res => {
        request(url2).then(locations => transformData(res.result.records, locations.result.records, map))
})
    .catch(console.error)
}

//api call to ckan
function request(url){
    return new Promise((resolve, reject) => {
        $.ajax({
            url: url,
            dataType: 'jsonp',
            success: data => resolve(data),
            fail:err => reject(err)
        })
    })
}

//creates circles based on the size of the values
function createCircle(value){
    let i = Math.floor(colors.length/3000 * value)
    if(i >= colors.length) i = colors.length-1
    let color = colors[i]
    console.log(color)
    return {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: color,
        fillOpacity: 1,
        scale:value/100 + 20,
        strokeColor: 'white',
    strokeWeight: 2
    };
}

//creates a marker
function addMarker(d, map){
    console.log(d)
    let circle = createCircle(d.data)
    let label = {
        text:d.data + "",
        color:'white',
        fontFamily:'Roboto',
        fontWeight:'bolder',
        fontSize:'20px'
    }
    return new google.maps.Marker({
        position: d.pos,
        icon: circle,
        label:label,
        labelClass:'labels',
        map: map,
        marker_data:d.data
    });
}</code></pre>

                    <h3 id="boaspraticas">Boas Práticas por tipos de dados</h3>

                    <p>● Quando deve ser usado um gráfico de barras</p>
                    <p>Lorem Ipsum</p>

                    <p>● Quando deve ser usado um gráfico de linhas</p>
                    <p>Lorem Ipsum</p>

                    <p>● Quando deve ser usado um gráfico que cruze informação de vários datasets</p>
                    <p>Lorem Ipsum</p>

                </div>
                 <div class="col-sm-3 col-xs-12">
                      <div class="sidebar">
                          <ul>
                              <li class="active"><a>Charts</a></li>
                              <li><a>Google Maps</a></li>
                              <li><a>Boas Práticas</a></li>
                          </ul>
                      </div>
                 </div>
            </div>
        </section>
        
        <script type="text/javascript" src="assets/js/jquery.min.js"></code>
        <script type="text/javascript" src="assets/js/masonry.pkgd.js"></script>
        <script type="text/javascript" src="assets/plugins/bootstrap-3.3.7/js/bootstrap.min.js" ></script>
        <script type="text/javascript" src="assets/js/prism.js"></script>
        <script type="text/javascript" src="assets/js/modules.js"></script>
    </body>
</html>
